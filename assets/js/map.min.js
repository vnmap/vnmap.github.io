var currentMarker,MAP_MOVE_SETTIMEOUT,MOUSE_EVENT,AUDIO,PLACE_DETAIL,XHR_REVERSE,DEFAULT_HOME=[16.1024476,106.0078059],DEFAULT_ZOOM=6,DEFAULT_TITLE="VNMap - Bản đồ số Việt Nam",MAP_MOVE_TIMEOUT=500,NO_PLACE_IMAGE="https://map.fimo.com.vn/assets/images/no_street.png",NO_DETAIL_IMAGE="https://map.fimo.com.vn/assets/images/hoa-sen.jpg";function removeCurrentMarker(){if(currentMarker){map.removeLayer(currentMarker),currentMarker=null;var e=L.DomUtil.get("place");L.DomUtil.addClass(e,"d-none")}}function getJSON(e,t,a,n=!1){var i=new XMLHttpRequest;n&&XHR_REVERSE&&(XHR_REVERSE.abort(),XHR_REVERSE=i),i.onreadystatechange=function(){4===i.readyState&&(200===i.status||304===i.status?a(JSON.parse(i.response)):a(""))},i.open("GET",e+L.Util.getParamString(t),!0),i.setRequestHeader("Accept","application/json"),i.send(null)}function reversePlace(e,t,a){getJSON("/geocode/reverse.php",{lat:e,lon:t,format:"json",addressdetails:1,namedetails:1},n=>{(n=handlePlace(n,e,t))&&a(n)},!0)}function geocodePlace(e,t){getJSON("/search",{q:e,format:"json",limit:1,addressdetails:1,namedetails:1},e=>{t(e)})}function getPlacebyClick(e,t,a){reversePlace(e,t,a=>{a.error||(previewImages(a.osm_id),addCurrentMarker(e,t,a.display_name,a),playMarker(a.display_name))})}function addCurrentMarker(e,t,a,n){removeCurrentMarker(),PLACE_DETAIL=n,currentMarker=L.marker([e,t],{icon:L.icon({iconUrl:"/assets/images/place-marker.png",opacity:.8,iconAnchor:L.point(12,24)})}).addTo(map);var i=a.split(", "),l=(i=i.filter(function(e){return"Việt Nam"!=e})).join(", "),o=L.DomUtil.get("place");L.DomUtil.removeClass(o,"d-none"),n&&n.address&&n.address.postcode&&(l=l.replace(`, ${n.address.postcode}`,"")),placename.innerHTML=l,placelocation.innerHTML=e.toFixed(7)+", "+t.toFixed(7)}function clickPlaceDetail(){removeCurrentMarker(),$("#icon_routing").hasClass("opened")&&geoCoding._direction(),PLACE_DETAIL&&(jumpPlace(PLACE_DETAIL.display_name,PLACE_DETAIL.lat,PLACE_DETAIL.lon),detailAddress(PLACE_DETAIL),toggleDetailmenu(!0))}function clickMap(e){geoCoding._clearResults(),currentMarker?removeCurrentMarker():getPlacebyClick(e.latlng.lat,e.latlng.lng)}function toggleLeftmenu(){var e=L.DomUtil.get("leftMenu");L.DomUtil.hasClass(e,"slide-left")?L.DomUtil.removeClass(e,"slide-left"):L.DomUtil.addClass(e,"slide-left")}function toggleDetailmenu(e=!0){var t=L.DomUtil.get("detail");L.DomUtil.hasClass(t,"detail-left")&&!e?L.DomUtil.removeClass(t,"detail-left"):!L.DomUtil.hasClass(t,"detail-left")&&e&&L.DomUtil.addClass(t,"detail-left")}function toggleExpand(){var e=L.DomUtil.get("submenu");L.DomUtil.hasClass(e,"active")?L.DomUtil.removeClass(e,"active"):L.DomUtil.addClass(e,"active")}function getViewbox(){var e=findViewbox();if(checkValidPlace(),checkValidDir(),e){var t=location.pathname.split("/")[e];return checkValidViewbox(t)?(t=t.replace("@","").replace("z","").split(","),{lat:parseFloat(t[0])||0,lon:parseFloat(t[1])||0,z:parseInt(t[2])||0}):void 0}}function creatViewbox(e,t,a){return`@${e},${t},${a}z`}function findViewbox(){var e;return location.pathname.split("/").forEach((t,a)=>{0!==t.indexOf("@")||t.indexOf("z")!==t.length-1||e||(e=a)}),e}function checkValidViewbox(e=""){return 3===(e=e.replace("@","").replace("z","").split(",")).length&&!((e={lat:parseFloat(e[0])||0,lon:parseFloat(e[1])||0,z:parseInt(e[2])||0}).lon>180||e.lon<-180||e.lat>90||e.lat<-90||e.z<0||e.z>20)}function moveMap(){MAP_MOVE_SETTIMEOUT&&clearTimeout(MAP_MOVE_SETTIMEOUT),MAP_MOVE_SETTIMEOUT=setTimeout(()=>{removeCurrentMarker();var e=location.pathname.split("/"),t=findViewbox();t||(t=e.length-1),e[t]=creatViewbox(map.getCenter().lat.toFixed(7),map.getCenter().lng.toFixed(7),map.getZoom()),changeUrl(e.join("/"))},MAP_MOVE_TIMEOUT)}function changeUrl(e,t){t=t?t+=" - Bản đồ số Việt Nam":document.title,e=e||location.pathname,document.title=t,window.history.pushState({urlPath:e},"",e||location.href)}function getVoice(e,t){getJSON("/voice",{address:e},e=>{t(e)})}function playText(e){var t=L.DomUtil.get("voiceButton");L.DomUtil.hasClass(t,"voice-active")&&getVoice(e,e=>{e.error?console.log(e.msg):(AUDIO&&AUDIO.pause(),(AUDIO=new Audio(e.audio_url)).play())})}function playMarker(e){var t=e.split(", ");playText(e=(t=t.filter(function(e){return!("Việt Nam"==e||parseInt(e)&&t.indexOf(e)>2)})).join(", "))}function creatPlace(e){return(e=e.split("+").join("^")).split(" ").join("+")}function findPlace(){var e,t=location.pathname.split("/");return t.forEach((a,n)=>{"place"==a&&t[n+1]&&findViewbox()!=n+1&&(e=n)}),e}function getPlace(){var e=location.pathname.split("/"),t=findPlace();return t?e[t+1].split("+").join(" "):void 0}function getPlaceName(e=!1){var t=getPlace();return t?(t=(t=decodeURIComponent(t)).split("^").join("+"),e?t.split(",")[0]:t):void 0}function newPlace(e){clearDir(),e.split("/").join(" ");var t=location.pathname.split("/");t.shift();var a=findPlace();a?t[a]=creatPlace(e):(t.unshift(creatPlace(e)),t.unshift("place")),t.unshift(""),changeUrl(t.join("/"),e.split(",")[0])}function clearPlace(){var e=location.pathname.split("/"),t=findPlace();t&&(e.splice(t,2),changeUrl(e.join("/")))}function checkValidPlace(){var e=getPlaceName();e&&geocodePlace(e,t=>{t.length>0?(jumpPlace(e,t[0].lat,t[0].lon),detailAddress(t[0]),toggleDetailmenu(!0)):clearPlace()})}function jumpPlace(e,t,a){map.setView([t,a],16);var n=e.split(", ");n=n.filter(function(e){return!parseInt(e)&&"Việt Nam"!=e}),newPlace(e),geoCoding._input.value=n[0],geoCoding._clearMarker(),geoCoding._geocodeMarker=new L.Marker([t,a]).bindPopup(n.join(", ")).addTo(map),geoCoding._changeRouteIcon(!1)}function detailAddress(e){e.properties&&(e=e.properties),detailImages(e.osm_id||"");const t=e.display_name?e.display_name.split(", ")[0]:e.name.split(", ")[0];$(".detail-address-title").html(t);const a=e.address.county||e.address.neighbourhood||"",n=e.address.state||e.address.suburb||"",i=e.address.country||"";MOUSE_EVENT={latlng:{lat:e.lat,lng:e.lon}},$("#county").html(a),$("#state").html(n),$("#country").html(i),e&&e.address&&e.address.postcode&&(e.display_name=e.display_name.replace(`, ${e.address.postcode}`,"")),$("#display-name").html(e.display_name),$("#display-location").html(`${e.lat}, ${e.lon}`),randomRating()}function randomRating(){let e=Math.floor(3*Math.random())+1;$(`#r${e}`).prop("checked",!0)}function detailImages(e){e?$.getJSON(`/images/${e}`,e=>{e.success?pushImage("data:image/png;base64,"+e.images[0]):pushImage(),delete e}).fail(function(){pushImage()}):pushImage()}function previewImages(e){document.getElementById("preview-image").src=NO_PLACE_IMAGE,e?$.getJSON(`/images/${e}`,e=>{e.success?document.getElementById("preview-image").src="data:image/png;base64,"+e.images[0]:document.getElementById("preview-image").src=NO_PLACE_IMAGE,delete e}).fail(function(){document.getElementById("preview-image").src=NO_PLACE_IMAGE}):document.getElementById("preview-image").src=NO_PLACE_IMAGE}function pushImage(e=NO_DETAIL_IMAGE){document.getElementById("detail-image").src=e}function toggleVoice(){var e=L.DomUtil.get("voiceButton");L.DomUtil.hasClass(e,"voice-active")?L.DomUtil.removeClass(e,"voice-active"):L.DomUtil.addClass(e,"voice-active")}function addDir(){clearPlace(),clearDir();var e=location.pathname.split("/");e.shift();const t=routingControl.getWaypoints();for(let a=t.length;a>0;a--)t[a-1].latLng&&t[a-1].latLng.lat&&t[a-1].latLng.lng&&e.unshift(`${t[a-1].latLng.lat.toFixed(6)},${t[a-1].latLng.lng.toFixed(6)}`);e.unshift("dir"),e.unshift(""),changeUrl(e.join("/"),"")}function clearDir(){name.split("/").join(" ");var e=location.pathname.split("/");let t=getDir();t&&(e.shift(),e.shift("dir"),t.forEach(t=>{e.shift(`${t.lat},${t.lng}`)}),e.unshift(""),changeUrl(e.join("/"),name.split(",")[0]))}function findDir(){var e,t=location.pathname.split("/");return t.forEach((a,n)=>{"dir"==a&&t[n+1]&&2==t[n+1].split(",").length&&t[n+2]&&2==t[n+2].split(",").length&&findViewbox()!=n+1&&(e=n)}),e}function getDir(){var e=location.pathname.split("/"),t=findDir();let a=[];return t?(e.forEach((e,n)=>{if(e&&n>=t){let t=e.split(",");2==t.length&&parseFloat(t[0])&&parseFloat(t[1])&&a.push({lat:parseFloat(t[0]).toFixed(6),lng:parseFloat(t[1]).toFixed(6)})}}),a.length>1?a:void 0):void 0}function checkValidDir(){var e=getDir();let t=0;if(e){e.forEach((e,a)=>{reversePlace(e.lat,e.lng,n=>{1===a&&changeUrl("",n.display_name.split(",")[0]);let i=routingControl.getWaypoints();i[a]=L.routing.waypoint([e.lat,e.lng],n.display_name),routingControl.setWaypoints(i),t++})});let a=setInterval(()=>{t==e.length&&($("#icon_routing").hasClass("opened")||geoCoding._direction(),routingControl.route(),clearInterval(a))},100)}}function handlePlace(e,t,a){return e&&e.display_name?(e.display_name=e.display_name.split("Trung Hoa").join(""),e.display_name=e.display_name.split("Trung Quốc").join(""),e.display_name=e.display_name.split("China").join(""),e.display_name=e.display_name.split("Đài Loan").join(""),e.display_name=e.display_name.split("Taiwan").join(""),e.display_name.indexOf("Hoàng Sa")<0||checkInBBox(t,a,HOANG_SA_BBOX)&&e.display_name.indexOf("Hoàng Sa")>0?e:void 0):void 0}function checkInBBox(e,t,a){return e>a.lat[0]&&e<a.lat[1]&&t>a.lng[0]&&t<a.lng[1]}const HOANG_SA_BBOX={lng:[111,118],lat:[7.6,18.1]};